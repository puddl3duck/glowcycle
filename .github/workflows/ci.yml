name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Validation Job
  validate:
    name: Validate Project Structure
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Check project structure
      run: |
        echo "✓ Checking project structure..."
        test -d frontend && echo "✓ Frontend folder exists"
        test -d backend && echo "✓ Backend folder exists"
        test -d infrastructure && echo "✓ Infrastructure folder exists"
        test -d docs && echo "✓ Documentation folder exists"
        test -f README.md && echo "✓ README.md exists"
        test -f LICENSE && echo "✓ LICENSE exists"
        echo "✓ Project structure validation complete"
    
    - name: Validate HTML files
      run: |
        echo "✓ Validating HTML files..."
        find frontend -name "*.html" -type f | while read file; do
          echo "Checking $file"
        done
        echo "✓ HTML validation complete"
    
    - name: Validate CSS files
      run: |
        echo "✓ Validating CSS files..."
        find frontend/css -name "*.css" -type f | while read file; do
          echo "Checking $file"
        done
        echo "✓ CSS validation complete"
    
    - name: Validate JavaScript files
      run: |
        echo "✓ Validating JavaScript files..."
        find frontend/js -name "*.js" -type f | while read file; do
          echo "Checking $file"
        done
        echo "✓ JavaScript validation complete"

  # Backend Validation
  backend-validate:
    name: Backend Validation
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Check Python files exist
      run: |
        echo "✓ Checking backend structure..."
        test -d backend/journal && echo "✓ Journal module exists"
        test -d backend/period && echo "✓ Period module exists"
        test -d backend/skin && echo "✓ Skin module exists"
        test -d backend/utils && echo "✓ Utils module exists"
        test -f backend/requirements.txt && echo "✓ Requirements file exists"
        echo "✓ Backend structure validation complete"
    
    - name: Validate Python syntax
      run: |
        python -m py_compile backend/journal/handler.py
        python -m py_compile backend/period/handler.py
        python -m py_compile backend/skin/handler.py
        python -m py_compile backend/utils/bedrock_client.py
        python -m py_compile backend/utils/dynamodb_client.py
        python -m py_compile backend/utils/s3_client.py
        echo "✓ Python syntax validation complete"

  # Infrastructure Validation
  infrastructure-validate:
    name: Infrastructure Validation
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Check infrastructure files
      run: |
        echo "✓ Checking infrastructure structure..."
        test -f infrastructure/package.json && echo "✓ package.json exists"
        test -f infrastructure/tsconfig.json && echo "✓ tsconfig.json exists"
        test -f infrastructure/cdk.json && echo "✓ cdk.json exists"
        test -f infrastructure/glow_cycle.ts && echo "✓ CDK app exists"
        test -f infrastructure/glow_cycle_stack.ts && echo "✓ CDK stack exists"
        echo "✓ Infrastructure structure validation complete"
    
    - name: Install dependencies
      run: |
        cd infrastructure
        npm install
    
    - name: Validate TypeScript
      run: |
        cd infrastructure
        npx tsc --noEmit
      continue-on-error: true

  # Documentation Check
  docs-check:
    name: Documentation Check
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Check documentation
      run: |
        echo "✓ Checking documentation..."
        test -f README.md && echo "✓ Main README exists"
        test -f CHANGELOG.md && echo "✓ CHANGELOG exists"
        test -f LICENSE && echo "✓ LICENSE exists"
        test -f CODE_OF_CONDUCT.md && echo "✓ CODE_OF_CONDUCT exists"
        test -d docs/guides && echo "✓ Guides folder exists"
        test -d docs/architecture && echo "✓ Architecture docs exist"
        test -d docs/dark-mode && echo "✓ Dark mode docs exist"
        echo "✓ Documentation check complete"
